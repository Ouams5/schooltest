<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bni Yekhlef High School — Portal (SPA)</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0a67d1; --success:#10b981; --danger:#ef4444;
  --radius:12px; --shadow:0 8px 30px rgba(2,6,23,0.06);
  font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);min-height:100vh;color:#0f172a}
.app{max-width:1100px;margin:28px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{font-weight:700;font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
.lang{padding:8px;border-radius:8px;border:1px solid #e6eef7;background:white}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(10,103,209,0.12);color:var(--accent)}
.layout{display:grid;grid-template-columns:240px 1fr;gap:16px}
.sidebar{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);height:calc(100vh - 120px);position:sticky;top:60px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.nav button{background:transparent;border:0;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
.nav button.active{background:linear-gradient(90deg, rgba(10,103,209,0.08), rgba(10,103,209,0.03));border-left:4px solid var(--accent);padding-left:8px}
.view{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);min-height:420px}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.input{padding:10px;border-radius:8px;border:1px solid #e6eef7;background:white}
.chat-window{height:300px;overflow:auto;padding:10px;border-radius:8px;border:1px solid #eef2f7;background:#fbfdff}
.card{background:var(--card);padding:12px;border-radius:10px;border:1px solid #eef2f7}
.modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal .modal-inner{background:white;padding:16px;border-radius:10px;width:100%;max-width:520px;box-shadow:var(--shadow)}
.notif-wrap{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:10000}
.notif{padding:10px 14px;border-radius:8px;background:white;box-shadow:var(--shadow);min-width:220px;opacity:0;transform:translateX(10px);transition:all .25s}
.notif.show{opacity:1;transform:translateX(0)}
.notif.success{border-left:4px solid var(--success)}
.notif.error{border-left:4px solid var(--danger)}
.notif.warn{border-left:4px solid #f59e0b}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
@media(max-width:900px){.layout{grid-template-columns:1fr}.sidebar{position:relative;height:auto}}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="brand">Bni Yekhlef High School</div>
    <div class="controls">
      <select id="lang" class="lang">
        <option value="en">EN</option><option value="fr">FR</option><option value="ar">AR</option>
      </select>
      <div id="authControls" style="display:flex;gap:8px;align-items:center">
        <button id="btnOpenAuth" class="btn ghost">Login / Register</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="card">
        <div id="sideUser" class="small">Not signed in</div>
        <div id="sideEmail" style="font-weight:600;margin-top:8px"></div>
      </div>

      <nav class="nav" style="margin-top:12px">
        <button data-view="dashboard" class="active">Dashboard</button>
        <button data-view="events">Events</button>
        <button data-view="clubs">Clubs</button>
        <button data-view="profile">Profile</button>
        <button data-view="admin" id="navAdmin" class="hidden">Admin Panel</button>
      </nav>

      <div style="margin-top:12px">
        <button id="btnLogout" class="btn ghost hidden">Logout</button>
      </div>
      <div style="margin-top:12px" class="small">Admin login: <strong>admin@school.com</strong> / <strong>admin123</strong></div>
    </aside>

    <main>
      <!-- dashboard view -->
      <section id="dashboard" class="view">
        <h3>Dashboard</h3>
        <p class="small">Your dashboard — content unlocked after login.</p>
        <div id="dashContent" style="margin-top:12px"></div>
      </section>

      <!-- events -->
      <section id="events" class="view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Events</h3>
          <div>
            <button id="btnAddEvent" class="btn hidden">Create Event</button>
          </div>
        </div>
        <div id="eventsList" style="margin-top:12px"></div>
      </section>

      <!-- clubs -->
      <section id="clubs" class="view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Clubs</h3>
          <div>
            <button id="btnAddClub" class="btn hidden">Create Club</button>
          </div>
        </div>
        <div id="clubsList" style="margin-top:12px"></div>
      </section>

      <!-- profile -->
      <section id="profile" class="view hidden">
        <h3>Profile</h3>
        <div class="card">
          <div id="profileInfo" class="small">Load profile after sign in.</div>
        </div>
      </section>

      <!-- admin -->
      <section id="admin" class="view hidden">
        <h3>Admin Panel</h3>
        <div class="card" style="margin-top:12px">
          <h4>Manage</h4>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnManageEvents" class="btn">Manage Events</button>
            <button id="btnManageClubs" class="btn">Manage Clubs</button>
          </div>
          <div id="adminArea" style="margin-top:12px"></div>
        </div>
      </section>
    </main>
  </div>

  <div class="footer">© Bni Yekhlef High School</div>
</div>

<!-- auth modal -->
<div id="authModal" class="modal hidden">
  <div class="modal-inner">
    <h3 id="authTitle">Sign in / Register</h3>
    <div class="form-row">
      <input id="modalEmail" class="input" placeholder="Email" />
      <input id="modalPass" class="input" type="password" placeholder="Password" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="modalRegister" class="btn ghost" data-original-text="Register">Register</button>
      <button id="modalLogin" class="btn" data-original-text="Login">Login</button>
    </div>
    <p class="small" style="margin-top:10px">Tip: Admin credentials above will be treated as admin for demo. For production add admin UID(s) in Firestore collection <code>admins/{uid}</code>.</p>
  </div>
</div>

<!-- create event modal -->
<div id="eventModal" class="modal hidden">
  <div class="modal-inner">
    <h3>Create Event</h3>
    <div class="form-row">
      <input id="evTitle" class="input" placeholder="Title" />
      <input id="evDate" class="input" type="date" />
      <input id="evPlace" class="input" placeholder="Place (optional)" />
      <textarea id="evDesc" class="input" placeholder="Description"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="evCancel" class="btn ghost">Cancel</button>
      <button id="evSave" class="btn">Create</button>
    </div>
  </div>
</div>

<!-- create club modal -->
<div id="clubModal" class="modal hidden">
  <div class="modal-inner">
    <h3>Create Club</h3>
    <div class="form-row">
      <input id="clubName" class="input" placeholder="Club name" />
      <input id="clubSubject" class="input" placeholder="Subject" />
      <textarea id="clubDesc" class="input" placeholder="Description"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="clubCancel" class="btn ghost">Cancel</button>
      <button id="clubSave" class="btn">Create Club</button>
    </div>
  </div>
</div>

<!-- notifications -->
<div class="notif-wrap" id="notifWrap"></div>

<!-- Firebase modular SDK (CDN) -->
<script type="module">
/* =========================
   Firebase modular imports
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  setDoc,
  doc,
  serverTimestamp,
  onSnapshot,
  query,
  orderBy,
  getDoc,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ----------------------------
   Firebase config (your project)
   ---------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD6ha3-iiXidoa0KnB9PuA0fnlqDUkcV2g",
  authDomain: "bniyekhlef-high-school.firebaseapp.com",
  projectId: "bniyekhlef-high-school",
  storageBucket: "bniyekhlef-high-school.firebasestorage.app",
  messagingSenderId: "807833913334",
  appId: "1:807833913334:web:a5eb4e2b96c0c32f2169d7",
  measurementId: "G-QCWNGXXRPP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ----------------------------
   Helpers: UI + Notifications
   ---------------------------- */
function showNotif(text, kind = 'success') {
  const wrap = document.getElementById('notifWrap');
  const n = document.createElement('div');
  n.className = 'notif ' + (kind==='warn'?'warn':(kind==='error'?'error':'success'));
  n.textContent = text;
  wrap.appendChild(n);
  requestAnimationFrame(()=> n.classList.add('show'));
  setTimeout(()=> { n.classList.remove('show'); setTimeout(()=> n.remove(),300); }, 3500);
}

/* view switching */
const navButtons = document.querySelectorAll('.nav button');
navButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    navButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const view = btn.dataset.view;
    document.querySelectorAll('main section.view').forEach(s=> s.classList.add('hidden'));
    document.getElementById(view).classList.remove('hidden');
  });
});

/* modal helpers */
function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
function closeModal(id){ document.getElementById(id).classList.add('hidden'); }

/* auth modal wiring */
const authModal = document.getElementById('authModal');
document.getElementById('btnOpenAuth').addEventListener('click', ()=> openModal('authModal'));
authModal.addEventListener('click', e=> { if(e.target===authModal) closeModal('authModal'); });

/* event modal */
document.getElementById('btnAddEvent').addEventListener('click', ()=> openModal('eventModal'));
document.getElementById('evCancel').addEventListener('click', ()=> closeModal('eventModal'));
document.getElementById('evSave').addEventListener('click', onCreateEvent);

/* club modal */
document.getElementById('btnAddClub').addEventListener('click', ()=> openModal('clubModal'));
document.getElementById('clubCancel').addEventListener('click', ()=> closeModal('clubModal'));
document.getElementById('clubSave').addEventListener('click', onCreateClub);

/* auth modal buttons */
document.getElementById('modalRegister').addEventListener('click', onRegister);
document.getElementById('modalLogin').addEventListener('click', onLogin);

/* logout button */
document.getElementById('btnLogout').addEventListener('click', async ()=>{
  try{ await signOut(auth); showNotif('Logged out','success'); }
  catch(e){ showNotif(e.message,'error'); }
});

/* ----------------------------
   Admin logic helpers
   ---------------------------- */
let currentUser = null;
let isAdmin = false;
const ADMIN_EMAIL = 'admin@school.com';        // provided credential
const ADMIN_PASSWORD = 'admin123';            // provided credential

async function checkAdminRole(uid, email) {
  // 1) If email matches the admin email (quick demo), treat as admin
  if (email && email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) return true;

  // 2) Otherwise, check Firestore admins/{uid}
  try {
    const adm = await getDoc(doc(db,'admins',uid));
    return adm.exists();
  } catch(e) {
    console.error('admin check', e);
    return false;
  }
}

/* ----------------------------
   Register / Login / Auth
   ---------------------------- */
async function onRegister(){
  const email = document.getElementById('modalEmail').value.trim();
  const pass = document.getElementById('modalPass').value;
  if(!email || !pass){ showNotif('Email + password required','error'); return; }
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // create minimal profile doc
    await setDoc(doc(db,'users',cred.user.uid), { email: email, createdAt: serverTimestamp() }, { merge: true });
    showNotif('Registered & signed in','success');
    closeModal('authModal');
  } catch(e){
    showNotif(e.message,'error');
  }
}

async function onLogin(){
  const email = document.getElementById('modalEmail').value.trim();
  const pass = document.getElementById('modalPass').value;
  if(!email || !pass){ showNotif('Email + password required','error'); return; }
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    closeModal('authModal');
    showNotif('Logged in','success');
  } catch(e){
    showNotif(e.message,'error');
  }
}

/* ----------------------------
   Firestore listeners (events & clubs)
   ---------------------------- */
const eventsCol = collection(db,'events');
const qEvents = query(eventsCol, orderBy('createdAt','desc'));

onSnapshot(qEvents, snap=>{
  const list = document.getElementById('eventsList');
  list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="card small">No events yet.</div>'; return; }
  snap.forEach(d=>{
    const ev = d.data();
    const el = document.createElement('div');
    el.className = 'card';
    el.style.marginBottom = '10px';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:12px">
      <div>
        <div style="font-weight:700">${escapeHtml(ev.title||'Untitled')}</div>
        <div class="small">${escapeHtml(ev.description||'')}</div>
        <div class="small" style="margin-top:6px;color:var(--muted)">${ev.date||''} ${ev.place? ' • ' + escapeHtml(ev.place):''}</div>
      </div>
      <div style="text-align:right">
        <div class="small">${ev.creatorEmail||''}</div>
        ${isAdmin ? `<button style="margin-top:8px" class="btn ghost" onclick="deleteEvent('${d.id}')">Delete</button>` : ''}
      </div>
    </div>`;
    list.appendChild(el);
  });
});

const clubsCol = collection(db,'clubs');
const qClubs = query(clubsCol, orderBy('createdAt','desc'));

onSnapshot(qClubs, snap=>{
  const list = document.getElementById('clubsList');
  list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="card small">No clubs yet.</div>'; return; }
  snap.forEach(d=>{
    const c = d.data();
    const el = document.createElement('div');
    el.className = 'card';
    el.style.marginBottom = '10px';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:12px">
      <div>
        <div style="font-weight:700">${escapeHtml(c.name||'Untitled')}</div>
        <div class="small">${escapeHtml(c.description||'')}</div>
        <div class="small" style="margin-top:6px;color:var(--muted)">Subject: ${escapeHtml(c.subject||'')}</div>
      </div>
      <div style="text-align:right">
        <div class="small">${c.creatorEmail||''}</div>
        ${isAdmin ? `<button style="margin-top:8px" class="btn ghost" onclick="deleteClub('${d.id}')">Delete</button>` : ''}
      </div>
    </div>`;
    list.appendChild(el);
  });
});

/* ----------------------------
   Create Event / Club (admin only)
   ---------------------------- */
async function onCreateEvent(){
  if(!currentUser){ showNotif('Sign in to create events','error'); return; }
  if(!isAdmin){ showNotif('Only admins can create events','error'); return; }
  const title = document.getElementById('evTitle').value.trim();
  const date = document.getElementById('evDate').value;
  const place = document.getElementById('evPlace').value.trim();
  const description = document.getElementById('evDesc').value.trim();
  if(!title || !description){ showNotif('Title and description required','error'); return; }
  try {
    await addDoc(eventsCol, {
      title, date, place, description,
      creatorUid: currentUser.uid, creatorEmail: currentUser.email,
      createdAt: serverTimestamp()
    });
    showNotif('Event created','success');
    closeModal('eventModal');
    // clear
    document.getElementById('evTitle').value=''; document.getElementById('evDate').value=''; document.getElementById('evPlace').value=''; document.getElementById('evDesc').value='';
  } catch(e){ showNotif(e.message,'error'); }
}

async function onCreateClub(){
  if(!currentUser){ showNotif('Sign in to create clubs','error'); return; }
  if(!isAdmin){ showNotif('Only admins can create clubs','error'); return; }
  const name = document.getElementById('clubName').value.trim();
  const subject = document.getElementById('clubSubject').value.trim();
  const description = document.getElementById('clubDesc').value.trim();
  if(!name || !subject || !description){ showNotif('All fields required','error'); return; }
  try {
    await addDoc(clubsCol, {
      name, subject, description,
      creatorUid: currentUser.uid, creatorEmail: currentUser.email,
      createdAt: serverTimestamp()
    });
    showNotif('Club created','success');
    closeModal('clubModal');
    document.getElementById('clubName').value=''; document.getElementById('clubSubject').value=''; document.getElementById('clubDesc').value='';
  } catch(e){ showNotif(e.message,'error'); }
}

/* delete helpers - admin only */
window.deleteEvent = async (id) => {
  if(!isAdmin){ showNotif('Admin only','error'); return; }
  if(!confirm('Delete event?')) return;
  try { await deleteDoc(doc(db,'events',id)); showNotif('Deleted','success'); }
  catch(e){ showNotif(e.message,'error'); }
};
window.deleteClub = async (id) => {
  if(!isAdmin){ showNotif('Admin only','error'); return; }
  if(!confirm('Delete club?')) return;
  try { await deleteDoc(doc(db,'clubs',id)); showNotif('Deleted','success'); }
  catch(e){ showNotif(e.message,'error'); }
};

/* ----------------------------
   Auth state & UI updates
   ---------------------------- */
onAuthStateChanged(auth, async user=>{
  currentUser = user;
  const sideUser = document.getElementById('sideUser');
  const sideEmail = document.getElementById('sideEmail');
  const btnLogout = document.getElementById('btnLogout');
  const navAdmin = document.getElementById('navAdmin');
  const addEventBtn = document.getElementById('btnAddEvent');
  const addClubBtn = document.getElementById('btnAddClub');

  if(user){
    sideUser.textContent = 'Signed in as';
    sideEmail.textContent = user.email;
    btnLogout.classList.remove('hidden');

    // check admin role
    isAdmin = await checkAdminRole(user.uid, user.email);
    if(isAdmin){
      navAdmin.classList.remove('hidden');
      addEventBtn.classList.remove('hidden');
      addClubBtn.classList.remove('hidden');
      document.getElementById('admin').classList.remove('hidden');
    } else {
      navAdmin.classList.add('hidden');
      addEventBtn.classList.add('hidden');
      addClubBtn.classList.add('hidden');
      document.getElementById('admin').classList.add('hidden');
    }

    // show dashboard content
    document.getElementById('dashContent').innerHTML = `<div class="card">Welcome, <strong>${escapeHtml(user.email)}</strong> — use the sidebar to navigate.</div>`;
    // load profile
    loadProfile();
  } else {
    sideUser.textContent = 'Not signed in';
    sideEmail.textContent = '';
    btnLogout.classList.add('hidden');
    navAdmin.classList.add('hidden');
    addEventBtn.classList.add('hidden');
    addClubBtn.classList.add('hidden');
    document.getElementById('admin').classList.add('hidden');

    document.getElementById('dashContent').innerHTML = `<div class="card small">Please sign in to access the dashboard and pages.</div>`;
    document.getElementById('profileInfo').textContent = 'Load profile after sign in.';
  }
});

/* ----------------------------
   Profile load/save (basic)
   ---------------------------- */
async function loadProfile(){
  if(!currentUser) return;
  const p = document.getElementById('profileInfo');
  try {
    const udoc = await getDoc(doc(db,'profiles',currentUser.uid));
    if(udoc.exists()){
      const d = udoc.data();
      p.innerHTML = `<div style="font-weight:700">${escapeHtml(d.name||currentUser.email)}</div><div class="small" style="margin-top:8px">${escapeHtml(d.bio||'')}</div>`;
    } else {
      p.innerHTML = `<div style="font-weight:700">${escapeHtml(currentUser.email)}</div><div class="small" style="margin-top:8px">No profile yet.</div>`;
    }
  } catch(e){ console.error(e); showNotif('Profile load error','error'); }
}

/* ----------------------------
   Utility
   ---------------------------- */
function escapeHtml(s){
  if(!s) return '';
  return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* ----------------------------
   Initial view & helpers
   ---------------------------- */
(function init(){
  // default view
  document.querySelectorAll('.nav button')[0].click();
  // close modals on backdrop click
  document.querySelectorAll('.modal').forEach(mod=>{
    mod.addEventListener('click', e=>{
      if(e.target === mod) mod.classList.add('hidden');
    });
  });
  // preload admin demo: optionally create admin user automatically (dangerous) — NOT doing that.
  // Instead: the admin credential provided works if you create that user in Firebase Auth console
  // For convenience, show notification
  showNotif('Welcome — sign in or register. Admin can create events/clubs.', 'success');
})();

</script>
</body>
</html>
